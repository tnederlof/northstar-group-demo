name: Demo SRE Test

on:
  pull_request:
    paths:
      - 'demo/sre/**'
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 6:00 UTC

jobs:
  test-sre:
    name: Test SRE Harness
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Setup SRE environment
        run: make sre-setup

      - name: Deploy healthy scenario
        run: make sre-demo SCENARIO=platform/healthy

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for fider deployment to be available..."
          kubectl --context=kind-fider-demo -n demo-healthy wait --for=condition=available \
            deployment/fider --timeout=180s

      - name: Verify scenario deployment
        run: make sre-verify SCENARIO=platform/healthy

      - name: Health check
        run: make sre-health SCENARIO=platform/healthy

      - name: Teardown scenario
        run: make sre-down-all
        if: always()

      - name: Delete kind cluster
        run: make sre-cluster-down
        if: always()
